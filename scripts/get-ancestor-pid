#!/bin/bash

set -euo pipefail

# Function to find the PID of a specific ancestor process name
get_ancestor_pid() {
  local target_name="$1"
  local current_pid=$$ # Start with the current shell's PID

  while true; do
    # Extract the parent PID (PPid) and process name
    read -r ppid name < <(awk '/PPid:/{print $2}; /^Name:/{print $2}' /proc/"$current_pid"/status)
    local ppid="$(awk '/^PPid:/{print $2}' /proc/"$current_pid"/status)"
    local name="$(awk '/^Name:/{print $2}' /proc/"$current_pid"/status)"

    if [ "$name" = "$target_name" ]; then
      echo "$current_pid"
      return
    fi

    if [ "$ppid" -eq 0 ] || [ "$current_pid" -eq "$ppid" ]; then
      # Reached init (PID 1) or a loop/error, ancestor not found
      echo "Ancestor $target_name not found" >&2
      return 1
    fi

    current_pid="$ppid"
  done
}

get_ancestor_pid "$@"
