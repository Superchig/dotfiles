#!/usr/bin/env python3
"""
Play each song in a YouTube playlist twice before moving to the next one.
Requires: yt-dlp and mpv
"""

import subprocess
import sys
import tempfile
import os


def get_playlist_urls(playlist_url):
    """Extract all video URLs from a YouTube playlist."""
    print("Fetching playlist information...")
    cmd = ["yt-dlp", "--flat-playlist", "--print", "url", playlist_url]

    try:
        result = subprocess.run(cmd, capture_output=True, text=True, check=True)
        urls = [line.strip() for line in result.stdout.split("\n") if line.strip()]
        return urls
    except subprocess.CalledProcessError as e:
        print(f"Error fetching playlist: {e}", file=sys.stderr)
        sys.exit(1)


def create_doubled_playlist(video_urls):
    """Create a playlist file where each video appears twice consecutively."""
    doubled_urls = []
    for url in video_urls:
        doubled_urls.append(url)
        doubled_urls.append(url)
    return doubled_urls


def main():
    if len(sys.argv) != 2:
        print("Usage: python script.py <youtube_playlist_url>")
        print("Example: python script.py 'https://www.youtube.com/playlist?list=...'")
        sys.exit(1)

    playlist_url = sys.argv[1]

    # Get all video URLs from the playlist
    video_urls = get_playlist_urls(playlist_url)
    print(f"Found {len(video_urls)} videos in playlist")

    # Create doubled playlist
    doubled_urls = create_doubled_playlist(video_urls)
    print(
        f"Created playlist with {len(doubled_urls)} entries (each song plays twice)\n"
    )

    # Create a temporary playlist file
    with tempfile.NamedTemporaryFile(mode="w", suffix=".txt", delete=False) as f:
        playlist_file = f.name
        for url in doubled_urls:
            f.write(url + "\n")

    try:
        print("Starting mpv...")
        print("Navigation controls:")
        print("  < or >  : Previous/Next track")
        print("  SPACE   : Pause/Play")
        print("  q       : Quit")
        print("  9 or 0  : Volume down/up")
        print()

        # Play the playlist with mpv
        cmd = [
            "mpv",
            # "--no-video",
            "--ytdl-format=bestaudio",
            "--playlist=" + playlist_file,
            "--term-osd-bar",  # Show progress bar
            # "--msg-level=all=status",  # Cleaner output
        ]

        subprocess.run(cmd)

    finally:
        # Clean up temporary file
        os.unlink(playlist_file)
        print("\nPlaylist finished!")


if __name__ == "__main__":
    main()
